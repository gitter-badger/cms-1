"use strict";angular.module("config",[]).constant("ENV",{name:"production",basepath:"/cms"}),angular.module("cmsApp",["config","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngTagsInput","ui.bootstrap","mgcrea.ngStrap.datepicker","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.dateParser","mgcrea.ngStrap.timepicker"]).config(["$routeProvider",function(a){a.when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).when("/post/search",{templateUrl:"views/post/search.html",controller:"PostSearchCtrl"}).when("/post/:year/:month",{templateUrl:"views/post/create.html",controller:"PostCreateCtrl"}).when("/post/:year/:month/:sha/:url*",{templateUrl:"views/post/create.html",controller:"PostCreateCtrl"}).otherwise({redirectTo:"/auth"})}]).run(["$rootScope","$location","Resource",function(a,b,c){a.$on("$locationChangeStart",function(){return a.error=null,c.github?void 0:(b.path("/auth").replace(),!1)})}]),angular.module("cmsApp").controller("AuthCtrl",["$rootScope","$scope","$timeout","$location","oauth","User","Resource","Repository",function(a,b,c,d,e,f,g,h){b.finish=function(c){if(c){var e=angular.fromJson(c);b.user.repository=e,a.user=b.user,h.skelleton.get(b.user).then(function(b){a.user.skelleton=angular.fromJson(b)}),d.path("/post/search")}},b.getRepositories=function(a){if(b.user.organization=void 0,b.user.repositories=[],a){var c=angular.fromJson(a);b.user.organization=c,h.organization.get(c).repositories().then(function(a){b.user.repositories=a})}},b.authenticate=function(){e.popup("github",function(a,d){return a?window.alert(a):(g.github=d,void c(function(){b.user=f.info()},0))})}}]),angular.module("cmsApp").factory("Resource",function(){return{github:""}}),angular.module("cmsApp").factory("User",["_","Github",function(a,b){return{info:function(){var a=b.user.getAuth(),c=b.organization.list(),d={info:"",organizations:[],repositories:[]};return a.then(function(a){d.info=a}),c.then(function(a){d.organizations=a}),d}}}]),angular.module("cmsApp").factory("oauth",function(){var a=window.OAuth;return a.initialize("Szfec4hwKtUV3-BPVLEdvP93fUM"),a}),angular.module("cmsApp").filter("startFrom",function(){return function(a,b){return b=+b,"object"==typeof a&&a.length>0?a.slice(b):[]}}),angular.module("cmsApp").factory("_",function(){return window._}),angular.module("cmsApp").controller("PostSearchCtrl",["$rootScope","$scope","DateUtil","Repository",function(a,b,c,d){b.posts=[],b.maxSize=5,b.currentPage=1,b.filter={month:c.now.getMonth(),year:c.now.getYear()},b.pageChanged=function(){var a=(b.currentPage-1)*b.maxSize,c=b.maxSize,e=b.posts.slice(a,a+c);e.forEach(function(a){a.metadata||d.post.get(a).then(function(b){angular.extend(a,b)})})},d.post.list(a.user,b.filter).then(function(a){b.posts=a.reverse(),b.pageChanged()})}]),angular.module("cmsApp").service("DateUtil",["$filter",function(a){function b(a){var b=Math.abs(Math.floor(a));return(10>b?"0":"")+b}function c(a){var c=-a.getTimezoneOffset(),d=c>=0?"+":"-";return a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+d+b(c/60)+":"+b(c%60)}this.now={getMonth:function(){return(new Date).getMonth()},getYear:function(){return(new Date).getFullYear()}},this.format=function(b,c){var d=new Date(b,c);return a("date")(d,"yyyy/MM")},this.toISO8601=function(a){return c(new Date(a))},this.fromISO8601=function(a){return{toMilliseconds:function(){return new Date(a).getTime()}}}}]),angular.module("cmsApp").service("PostUtil",["DateUtil",function(a){function b(a){return a.replace(/[^\w\s]/gi,"")}function c(a){var b=a.replace(/[ ]([a-zA-Z0-9])/g,function(a,b){return"-"+b});return b}function d(a){var b=new Date(a.metadata.date);return b.toISOString().split("T")[0]}this.decodeContent=function(a){return decodeURIComponent(escape(atob(a)))},this.load=function(b){var c={},d=decodeURIComponent(escape(atob(b))).split("---");return c.body=d.pop().replace(/^\n/,""),c.metadata=window.jsyaml.load(d.pop()),c.createdTime=a.fromISO8601(c.metadata.date).toMilliseconds(),c},this.serialize=function(b){b.metadata.date=a.toISO8601(b.metadata.date);var c=["---",window.jsyaml.dump(b.metadata),"---",b.body].join("\n");return unescape(encodeURIComponent(c))},this.generateFileName=function(a){if(a.filename)return a.filename;var e=a.metadata.title.toLowerCase();return e=b(e),e=c(e),d(a)+"-"+e+".md"},this.prepareDraftPost=function(a,b,c){var d={metadata:a,body:b,filename:c};return d.filename=this.generateFileName(d),d.metadata.published=!1,d}}]),angular.module("cmsApp").factory("YoutubeLinkUtil",function(){function a(a){return a?c.exec(a)[1]:""}function b(b){return b?'<p style="text-align: center;"><iframe allowfullscreen="" name="coverVideo" frameborder="0" height="360" src="//www.youtube.com/embed/'+a(b)+'" width="640"></iframe></p>':""}var c=/(?:youtube\.(?:com|com\.br)\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/,d={pattern:function(){return c},link:function(c){return{getId:function(){return a(c)},getEmbed:function(){return b(c)}}}};return d}),angular.module("cmsApp").factory("Repository",["Github",function(a){var b={list:function(b,c){return a.content.posts(b,c)},get:function(b){return a.content.post(b)},save:function(b,c,d,e,f){return a.content.save(b,c,d,e,f)}},c={get:function(b){return a.content.skelleton(b)}};return{post:b,organization:a.organization,skelleton:c}}]),angular.module("cmsApp").factory("GithubOrganization",["$q","_","Resource",function(a,b,c){function d(b){var d=a.defer(),e=d.promise,f=c.github;return f.get("orgs/"+b.login).then(function(a){return d.resolve(a)}),e}function e(b){var d=a.defer(),e=d.promise,f=c.github;return f.get("orgs/"+b.login+"/repos").then(function(a){return d.resolve(a)}),e}function f(){var e=a.defer(),f=e.promise,g=c.github;return g.get("user/orgs").then(function(a){e.resolve(a)}),f.then(function(a){return b.each(a,function(b,c){var e=d(b);e.then(function(b){angular.extend(a[c],b)})}),a}),f}return{list:function(){return f()},get:function(a){return{repositories:function(){return e(a)},org:function(){return d(a)}}}}}]),angular.module("cmsApp").factory("GithubUser",["Resource","$q",function(a,b){return{getAuth:function(){var c=b.defer(),d=a.github;return d.get("user").then(function(a){c.resolve(a)}),c.promise}}}]),angular.module("cmsApp").factory("GithubContent",["$q","Resource","PostUtil","DateUtil",function(a,b,c,d){return{skelleton:function(d){var e=a.defer(),f=e.promise,g=b.github,h=["repos",d.repository.full_name,"contents/skelleton.json?ref=master"].join("/");return g.get(h,{type:"GET"}).then(function(a){var b=c.decodeContent(a.content);return e.resolve(b)}),f},post:function(d){var e=a.defer(),f=e.promise,g=b.github;return g.get(d.url).then(function(a){var b=c.load(a.content);return b.filename=a.name,e.resolve(b)}),f},posts:function(c,e){var f=d.format(e.year,e.month),g=["repos",c.repository.full_name,"contents/_posts",f].join("/"),h=a.defer(),i=h.promise,j=b.github;return j.get(g,{cache:!1}).then(function(a){return h.resolve(a)}),i},save:function(e,f,g,h,i){var j=c.serialize(f),k=JSON.stringify({sha:i,content:btoa(j),message:"commit from cms"}),l=d.format(g,h),m=["repos",e.repository.full_name,"contents/_posts",l,f.filename].join("/"),n=a.defer(),o=n.promise,p=b.github;return p.put(m,{data:k,cache:!1}).error(function(a,b){console.log(a,b)}).then(function(a){return n.resolve(a)}),o}}}]),angular.module("cmsApp").factory("Github",["GithubOrganization","GithubContent","GithubUser",function(a,b,c){return{organization:a,content:b,user:c}}]),angular.module("cmsApp").controller("PostCreateCtrl",["$rootScope","$scope","$location","$routeParams","PostUtil","Repository",function(a,b,c,d,e,f){b.state="saved",b.draft=function(g){var h=d.year,i=d.month,j=d.sha;if(b.$broadcast("submited"),!g.$invalid){b.state="saving";var k=e.prepareDraftPost(b.entity,b.body,b.filename);f.post.save(a.user,k,h,i,j).then(function(){b.state="saved",c.path("/post/search")})}},b.load=function(){var a={url:d.url};a.url&&f.post.get(a).then(function(a){b.entity=a.metadata,b.body=a.body,b.filename=a.filename})},b.entity={date:(new Date).toString()},b.body="",b.fields=a.user.skelleton}]),angular.module("cmsApp").directive("youtube",["$window","YoutubeLinkUtil",function(a,b){return{restrict:"E",scope:{url:"@"},template:"<div></div>",link:function(c,d){function e(){return new YT.Player(d.children()[0],{playerVars:{autoplay:0,html5:1,theme:"light",modesbranding:0,color:"white",iv_load_policy:3,showinfo:1,controls:1},height:"350px",width:"100%",videoId:b.link(c.url).getId()})}function f(){i||a.onYouTubeIframeAPIReady()}var g=document.createElement("script");g.src="https://www.youtube.com/iframe_api";var h=document.getElementsByTagName("script")[0];h.parentNode.insertBefore(g,h);var i;a.onYouTubeIframeAPIReady=function(){i=e()},c.$watch("url",function(a,c){a&&a!==c&&(f(),i.cueVideoById&&i.cueVideoById(b.link(a).getId()))})}}}]),angular.module("cmsApp").directive("expand",function(){return{restrict:"A",link:function(a,b){var c=function(){for(var a=b[0];a.rows>1&&a.scrollHeight<a.offsetHeight;)a.rows--;for(var c=0;a.scrollHeight>a.offsetHeight&&c!==a.offsetHeight;)c=a.offsetHeight,a.rows++};b.bind("keyup",function(){c()}),a.$watch(function(){return b[0].value},function(){c()})}}});var $defer,loaded;angular.module("cmsApp").run(["$q","$timeout",function(a,b){function c(){"loaded"===CKEDITOR.status?(loaded=!0,$defer.resolve()):c()}if($defer=a.defer(),angular.isUndefined(window.CKEDITOR))throw new Error("CKEDITOR not found");CKEDITOR.disableAutoInline=!0,CKEDITOR.on("loaded",c),b(c,100)}]).directive("ckEditor",["$q","$timeout","ENV",function(a,b,c){return{require:"?ngModel",link:function(d,e,f,g){var h=null,i="<p></p>",j=[],k=!1,l=function(){var f={toolbar:"full",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList","Blockquote"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"links",items:["Link","Unlink","Anchor"]},{name:"tools",items:["SpellChecker","Maximize"]},"/",{name:"styles",items:["Format","FontSize","TextColor","PasteText","PasteFromWord","RemoveFormat"]},{name:"insert",items:["Image","Youtube","Table","SpecialChar"]},{name:"forms",items:["Outdent","Indent"]},{name:"clipboard",items:["Undo","Redo"]},{name:"document",items:["PageBreak","Source"]}],disableNativeSpellChecker:!1,uiColor:"#FAFAFA",height:"400px",width:"100%"},l=CKEDITOR.replace(e[0],f);CKEDITOR.plugins.addExternal("youtube",c.basepath+"/ckeditor-plugins/youtube/","plugin.js"),l.config.extraPlugins="youtube,justify,image2",l.config.language="pt-BR";var m=a.defer();e.bind("$destroy",function(){l.destroy(!1)});var n=function(a){var c=l.getData();""===c&&(c=null),b(function(){(a!==!0||c!==g.$viewValue)&&g.$setViewValue(c),a===!0&&h&&h.$setPristine()},0)},o=function(a){if(j.length){var b=j.pop()||i;k=!1,l.setData(b,function(){n(a),k=!0})}};l.on("pasteState",n),l.on("change",n),l.on("blur",n),l.on("instanceReady",function(){d.$broadcast("ckeditor.ready"),d.$apply(function(){o(!0)}),l.document.on("keyup",n)}),l.on("customConfigLoaded",function(){m.resolve()}),g.$render=function(){j.push(g.$viewValue),k&&o()}};"loaded"===CKEDITOR.status&&(loaded=!0),loaded?l():$defer.promise.then(l)}}}]),angular.module("cmsApp").directive("showErrors",function(){return{restrict:"A",require:"^form",link:function(a,b,c,d){var e=b[0].querySelector("input, select, textarea"),f=angular.element(e),g=f.attr("name"),h=function(){if(d[g]){var a=d[g].$invalid;window.$(b.parent().get(0)).toggleClass("has-error",a),b.toggleClass("has-error",a)}};f.bind("blur",function(){h()}),a.$on("submited",function(){h()})}}}),angular.module("cmsApp").directive("dynamicName",["$compile",function(a){return{restrict:"A",terminal:!0,priority:2e3,link:function(b,c,d){c.attr("name",b.$eval(d.dynamicName)),c.removeAttr("dynamic-name"),a(c)(b)}}}]),angular.module("cmsApp").directive("dynamicRequired",["$compile",function(a){return{restrict:"A",terminal:!0,priority:1e3,link:function(b,c,d){var e=b.$eval(d.dynamicRequired),f=e.need;if(f){var g=f.field,h=f.value,i=f.equal?"===":"!==",j=["entity.",g,i,"'",h,"'"].join("");c.attr("ng-required",j)}else c.attr("ng-required","field.required");c.removeAttr("dynamic-required"),a(c)(b)}}}]);